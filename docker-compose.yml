# Boundless BLS Blockchain - Docker Compose Configuration
# This sets up a multi-node development environment

version: '3.8'

services:
  # Bootstrap Node (Mining Node)
  node1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boundless-node1
    ports:
      - "${P2P_PORT_NODE1:-30333}:30333"  # P2P
      - "${RPC_PORT_NODE1:-9933}:9933"    # RPC
    volumes:
      - node1-data:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-0}
    command: >
      --dev
      --mining
      --mining-threads ${MINING_THREADS:-1}
      --base-path /data
      --rpc-port 9933
      --port 30333
    networks:
      - boundless-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Regular Node 2
  node2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boundless-node2
    ports:
      - "${P2P_PORT_NODE2:-30334}:30333"  # P2P
      - "${RPC_PORT_NODE2:-9934}:9933"    # RPC
    volumes:
      - node2-data:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-0}
    command: >
      --dev
      --base-path /data
      --port 30333
      --rpc-port 9933
    networks:
      - boundless-network
    depends_on:
      - node1
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Regular Node 3
  node3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boundless-node3
    ports:
      - "${P2P_PORT_NODE3:-30335}:30333"  # P2P
      - "${RPC_PORT_NODE3:-9935}:9933"    # RPC
    volumes:
      - node3-data:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-0}
    command: >
      --dev
      --base-path /data
      --port 30333
      --rpc-port 9933
    networks:
      - boundless-network
    depends_on:
      - node1
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # CLI Container (for running commands)
  cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boundless-cli
    entrypoint: ["/usr/local/bin/boundless-cli"]
    command: ["--help"]
    networks:
      - boundless-network
    profiles:
      - tools
    restart: "no"

networks:
  boundless-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  node1-data:
    driver: local
  node2-data:
    driver: local
  node3-data:
    driver: local
